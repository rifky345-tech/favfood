<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Checkout - FavFood</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="css/icon.css" />
    <style>
      .line-clamp-2 {
        display: -webkit-box;
        -webkit-box-orient: vertical;
        overflow: hidden;
        text-overflow: ellipsis;
      }
    </style>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: "#05113b",
            },
          },
        },
      };
    </script>
  </head>
  <body class="bg-white w-full md:w-1/2 mx-auto">
    <div class="bg-gray-200 md:pb-6 min-h-screen">
      <div>
        <header class="bg-white shadow-md sticky top-0 z-50">
          <div
            class="container mx-auto px-4 py-4 flex items-center justify-between relative"
          >
            <a
              href="index.html"
              class="text-sm text-primary flex items-center space-x-1"
            >
              <i class="fas fa-arrow-left text-lg"></i>
            </a>

            <p
              class="absolute left-1/2 -translate-x-1/2 font-bold text-lg text-primary"
            >
              Pesanan
            </p>
          </div>
        </header>

        <!-- Content -->
        <main class="container mx-auto px-4 md:px-8 pt-6 pb-8 md:pt-8 md:pb-16">
          <div id="empty-state" class="hidden">
            <div
              class="bg-white rounded-lg shadow-md p-6 flex flex-col items-center text-center"
            >
              <i class="fas fa-shopping-cart text-4xl text-gray-300 mb-4"></i>
              <p class="text-gray-600 mb-4">
                Belum ada pesanan di keranjang Anda.
              </p>
              <a
                href="index.html"
                class="bg-primary text-white px-4 py-2 rounded-lg text-sm font-semibold hover:bg-opacity-90 transition"
              >
                Kembali ke Menu
              </a>
            </div>
          </div>

          <div id="order-detail" class="space-y-6 hidden">
            <!-- Ringkasan Item dan Pembayaran -->
            <div class="bg-white rounded-lg shadow-md p-4 md:p-6">
              <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-800">
                  Pesanan Anda
                </h3>
                <span id="order-count" class="text-sm text-gray-500"></span>
              </div>

              <div id="order-items"></div>

              <div class="mt-6 border-l-4 border-primary pl-1">
                <div id="notes-display" class="space-y-1 min-w-0"></div>
              </div>

              <div class="border-t border-gray-500 mt-10 pt-4">
                <h3 class="text-lg font-semibold text-black mb-4">
                  Ringkasan Pembayaran
                </h3>
                <div class="flex items-center justify-between">
                  <span class="text-black font-bold">Total</span>
                  <span
                    id="order-total"
                    class="text-xl font-bold text-black"
                  ></span>
                </div>
              </div>
            </div>

            <!-- Aksi -->
            <div
              class="flex flex-col md:flex-row items-stretch md:items-center justify-between gap-3"
            >
              <a
                href="index.html"
                class="w-full md:w-auto text-center border border-black text-black px-4 py-2 rounded-lg text-sm font-semibold"
              >
                Ubah Pesanan
              </a>
              <button
                onclick="confirmOrder()"
                class="w-full md:w-auto bg-primary text-white px-4 py-2 rounded-lg text-sm font-semibold hover:bg-opacity-90 transition"
              >
                Bayar
              </button>
            </div>
          </div>
        </main>

        <!-- Notes Modal -->
        <div
          id="notes-modal"
          class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-end justify-center"
        >
          <div
            class="bg-white w-full md:w-2/5 rounded-t-2xl shadow-lg max-h-[80vh] overflow-y-auto"
          >
            <div
              class="sticky top-0 bg-white border-b border-gray-200 px-4 py-4 flex items-center justify-between rounded-t-2xl"
            >
              <h3 class="text-lg font-bold text-black">Notes</h3>
              <button onclick="closeNotesModal()" class="text-black">
                <i class="fas fa-times text-xl"></i>
              </button>
            </div>
            <div class="p-4">
              <label
                for="customer-notes"
                class="block text-sm font-medium text-gray-700 mb-2"
              >
              </label>
              <textarea
                id="customer-notes"
                name="customer-notes"
                rows="6"
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent resize-none text-gray-700"
              ></textarea>
              <button
                onclick="addCustomerNote()"
                class="w-full mt-4 bg-primary text-white px-4 py-3 rounded-lg text-sm font-semibold"
              >
                Add
              </button>
            </div>
          </div>
        </div>

        <script>
          let customerNotes = "";

          function formatRupiah(number) {
            return "Rp " + Number(number).toLocaleString("id-ID");
          }

          function openNotesModal() {
            const modal = document.getElementById("notes-modal");
            const textarea = document.getElementById("customer-notes");
            const savedNote = localStorage.getItem("favfood_customer_note");
            if (savedNote) {
              textarea.value = savedNote;
              customerNotes = savedNote;
            }
            modal.classList.remove("hidden");
            setTimeout(() => textarea.focus(), 100);
          }

          function closeNotesModal() {
            const modal = document.getElementById("notes-modal");
            modal.classList.add("hidden");
          }

          function addCustomerNote() {
            const textarea = document.getElementById("customer-notes");
            const noteText = textarea.value.trim();
            customerNotes = noteText;
            localStorage.setItem("favfood_customer_note", noteText);
            renderNotes();
            closeNotesModal();
          }

          function renderNotes() {
            const notesDisplay = document.getElementById("notes-display");
            const savedNote = localStorage.getItem("favfood_customer_note");

            if (savedNote && savedNote.trim()) {
              notesDisplay.innerHTML = `
                <div 
                  onclick="openNotesModal()"
                  class="flex items-center space-x-2 cursor-pointer"
                >
                  <i class="fa-solid fa-file-pen text-lg italic font-semibold flex-shrink-0 text-primary"></i>
                  <div 
                    class="flex-1 min-w-0 italic text-black"
                    style="display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; text-overflow: ellipsis; word-break: break-word; line-height: 1.5em; max-height: 3em;"
                  >${savedNote}</div>
                </div>
              `;
            } else {
              notesDisplay.innerHTML = `
                <div 
                  onclick="openNotesModal()"
                  class="flex items-center space-x-1 text-primary cursor-pointer text-lg"
                >
                  <i class="fa-solid fa-file-pen text-md italic font-semibold flex-shrink-0"></i>
                  <span class="text-sm font-medium italic text-gray-500">Notes</span>
                </div>
              `;
            }
          }

          function loadNotes() {
            renderNotes();
          }

          function loadOrder() {
            const rawCart = localStorage.getItem("favfood_cart");
            let cart = [];
            if (rawCart) {
              try {
                const parsed = JSON.parse(rawCart);
                if (Array.isArray(parsed)) {
                  cart = parsed;
                }
              } catch (e) {
                console.error("Gagal membaca data keranjang", e);
              }
            }

            const emptyState = document.getElementById("empty-state");
            const orderDetail = document.getElementById("order-detail");

            if (!cart.length) {
              emptyState.classList.remove("hidden");
              orderDetail.classList.add("hidden");
              return;
            }

            emptyState.classList.add("hidden");
            orderDetail.classList.remove("hidden");

            const orderItemsEl = document.getElementById("order-items");
            const orderTotalEl = document.getElementById("order-total");
            const orderCountEl = document.getElementById("order-count");

            const totalItems = cart.reduce(
              (sum, item) => sum + (item.quantity || 0),
              0
            );
            const totalPrice = cart.reduce(
              (sum, item) => sum + item.price * (item.quantity || 0),
              0
            );

            orderCountEl.textContent = `${totalItems} item`;
            orderTotalEl.textContent = formatRupiah(totalPrice);

            orderItemsEl.innerHTML = cart
              .map(
                (item) => `
          <div class="py-3 flex items-start justify-between space-x-4">
            <div class="flex items-start space-x-3 flex-1">
              <img
                src="${
                  item.image || "https://via.placeholder.com/80?text=No+Image"
                }"
                alt="${item.name}"
                class="w-16 h-16 sm:w-20 sm:h-20 object-cover rounded-lg flex-shrink-0"
                onerror="this.src='https://via.placeholder.com/80?text=No+Image'"
              />
              <div class="flex-1 min-w-0">
                <p class="font-semibold text-gray-800">${item.name}</p>
                <p class="text-xs text-gray-500 mt-1">
                  ${formatRupiah(item.price)}
                </p>
              </div>
            </div>
            <div class="text-right flex-shrink-0 flex flex-col items-end">
              <p class="font-semibold text-primary">
                ${formatRupiah(item.price * (item.quantity || 0))}
              </p>
              <div class="flex items-center space-x-1 mt-1">
                <button
                  onclick="updateItemQuantity(${item.id}, -1)"
                  class="w-5 h-5 bg-gray-200 rounded flex items-center justify-center hover:bg-gray-300 transition"
                  title="Kurangi jumlah"
                >
                  <i class="fas fa-minus text-[10px]"></i>
                </button>
                <span class="w-6 text-center text-sm font-semibold text-gray-800">${
                  item.quantity || 0
                }</span>
                <button
                  onclick="updateItemQuantity(${item.id}, 1)"
                  class="w-5 h-5 bg-gray-200 rounded flex items-center justify-center hover:bg-gray-300 transition"
                  title="Tambah jumlah"
                >
                  <i class="fas fa-plus text-[10px]"></i>
                </button>
              </div>
            </div>
          </div>
        `
              )
              .join("");
          }

          function updateItemQuantity(itemId, change) {
            const rawCart = localStorage.getItem("favfood_cart");
            if (!rawCart) {
              return;
            }

            let cart = [];
            try {
              const parsed = JSON.parse(rawCart);
              if (Array.isArray(parsed)) {
                cart = parsed;
              }
            } catch (e) {
              console.error("Gagal membaca data keranjang", e);
              return;
            }

            const item = cart.find((i) => i.id === itemId);
            if (!item) {
              return;
            }

            item.quantity = (item.quantity || 0) + change;

            // Jika quantity <= 0, hapus item dari cart
            if (item.quantity <= 0) {
              cart = cart.filter((i) => i.id !== itemId);
            }

            // Simpan kembali ke localStorage
            try {
              localStorage.setItem("favfood_cart", JSON.stringify(cart));
            } catch (e) {
              console.error("Gagal menyimpan data keranjang", e);
              return;
            }

            // Reload order display
            loadOrder();
          }

          function confirmOrder() {
            const rawCart = localStorage.getItem("favfood_cart");
            if (!rawCart) {
              alert("Tidak ada pesanan untuk dikonfirmasi.");
              return;
            }

            let cart = [];
            try {
              const parsed = JSON.parse(rawCart);
              if (Array.isArray(parsed)) {
                cart = parsed;
              }
            } catch (e) {
              console.error(e);
            }

            if (!cart.length) {
              alert("Tidak ada pesanan untuk dikonfirmasi.");
              return;
            }

            // Arahkan ke halaman pembayaran
            window.location.href = "payment.html";
          }

          document.addEventListener("DOMContentLoaded", () => {
            loadOrder();
            loadNotes();

            // Close modal when clicking outside
            const modal = document.getElementById("notes-modal");
            if (modal) {
              modal.addEventListener("click", function (e) {
                if (e.target === this) {
                  closeNotesModal();
                }
              });
            }
          });
        </script>
      </div>
    </div>
  </body>
</html>
